{% extends 'base.html' %}
{% block title %}
Overview{% endblock %}
{% block content %}
  {% if user.is_authenticated %}

  <style>
    #removeButton {
    margin-top: 10px; /* Adjust as necessary for your layout */
    padding: .25rem .80rem; /* Similar padding to bootstrap's btn class */
    border-radius: 10px; /* Rounded borders */
    border: 1px solid #ced4da; /* Similar to default file input button */
    cursor: pointer; /* Pointer cursor on hover */
    font-size: 0.9rem; /* Adjust font size as needed */
    line-height: 0.9; /* For proper text alignment */
    transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out; /* Smooth transition for hover effects */
}
.custom-checkbox {
    display: inline-block;
    cursor: pointer;
}

.custom-checkbox .checkmark {
    display: inline-block;
    width: 13px; /* Adjust the width if necessary */
    height: 13px; /* Adjust the height if necessary */
    background: #fff; /* Change to the desired background color */
    border: 1px solid grey; /* Adjust the border color and size as needed */
    position: relative;
    transition: background 0.3s, border-color 0.3s; /* Smooth transition for background and border color */
}

/* When the checkbox is checked, add a blue background and an 'x' */
.custom-checkbox input:checked + .checkmark {
    background: red; /* This should match the blue background in the image when checked */
    border-color: red; /* Border color should also match */
}

.custom-checkbox input:checked + .checkmark::after {
    content: 'âœ•'; /* Unicode character for 'x' */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white; /* This should contrast with the blue background */
    font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; /* Ensure the 'x' is displayed correctly */
    font-size: 14px; /* Adjust the size of the 'x' as necessary */
    line-height: 1;
}
  #example th {
    text-align: center;
  }
  #example td:nth-child(1){
    text-align: center;
    width: 4%;
  }
  #example td:nth-child(2){
    text-align: left;
    width: 15%;
  }
  #example td:nth-child(3){
    text-align: center;
    width: 2%;

  }
  #example td:nth-child(4){
    text-align: center;
    width: 2%;

  }
  #example td:nth-child(5){
    text-align: center;
    width: 2%;

  }
  #example td:nth-child(6){
    text-align: center;
    width: 5%;

  }
  #example td:nth-child(7){
    text-align: center;
    width: 8%;

  }
  #example td:nth-child(8){
    text-align: center;
    width: 5%;

  }

  #example td:nth-child(9){
    text-align: center;
    width: 5%;

  }
  
  #example td:nth-child(10){
    text-align: center;
    width: 5%;

  }
  #example td:nth-child(11){
    text-align: center;
    width: 100%;

  }
  #example td:nth-child(12){
    text-align: center;
    width: 5%;
  }
  #example td:nth-child(13){
    text-align: center;
    width: 5%;

  }
  #example td:nth-child(14){
    text-align: center;
    width: 5%;

  }
  #example td:nth-child(15){
    text-align: center;
    width: 5%;

  }
  </style>
        <div class="col-lg-14 mx-auto">
            <div class="card-body p-5 bg-white rounded">
              <div >
                  <table id="example"class="table table-striped table-bordered">
                    <thead>
                      <tr>
                        <th>NO</th>
                        <th>WORK ORDERS</th>
                        <th>PA</th>
                        <th>PD</th>
                        <th>CEO</th>
                        <th>FIN</th>
                        <th>REQ FORM</th>
                        <th>EDIT WO</th>
                        <th>CONFIRM CHECK</th>
                        <th>REJECTION</th>
                        <th>REMARKS</th>
                        <th>DUE DATE</th>
                        <th>PAYMENT DATE</th>
                        <th>PROOF OF PAYMENT</th>
                        <th>DELETE WO</th>



                      </tr>
                    </thead>
                    <tbody>
                      {% for order in page_obj %}
                      <form method = "post" enctype="multipart/form-data">
                        {% csrf_token%}
                        <tr>
                          <td>
                            {{ forloop.counter|add:starting_index }}                         
                           </td>

                          <!-- CHECK ACI / BKS AND SET THEM CORRESPONDINGLY-->
                      
                          <td>
                            <input type="hidden" name="order" value="{{ order.id }}">
                            <input type="hidden" name="order_category" value="{{ order.category }}">
                            <input type="hidden" name="order_company" value="{{ order.company }}">
                            <input type="hidden" name="order_project" value="{{ order.project }}">
                            <a href="{% url 'view_wo' order.id order.category order.company order.project%}">{{ order.wo_string | safe }}</a>
                          </td>
                          <td>
                            <label class="container">
                              <input type="checkbox" {%if is_pa%}name="paCheck"{%endif%} {% if order.personalAssistantCheck %}checked="checked"{% endif %} {% if not is_pa %}disabled{% endif %}>

                              <span class="checkmark"></span>
                            </label>
                            <label class="custom-checkbox">
                              <input hidden type="checkbox" {%if is_pa%}name="paReject"{%endif%} {% if order.personalAssistantReject %}checked="checked"{% endif %} {% if not is_pa %}disabled{% endif %}>
                              <span class="checkmark"></span>
                            </label>

                          </td>
                          <td>
                            <label class="container">
                              <input type="checkbox" {%if is_rightHand%}name="rightHandCheck"{%endif%}{% if order.rightHandCheck %}checked="checked"{% endif %} {% if not is_rightHand %}disabled{% endif %}>
                              <span class="checkmark"></span>

                            </label>

                              <label class="custom-checkbox">
                                <input hidden type="checkbox" {%if is_rightHand%}name="rightHandReject"{%endif%} {% if order.rightHandReject %}checked="checked"{% endif %} {% if not is_rightHand %}disabled{% endif %}>
                                <span class="checkmark">
                                </span>
                            </label>
                          </td>
                          <td>
                            <label class="container">
                              <input type="checkbox" {%if is_ceo%}name="ceoCheck"{%endif%}{% if order.ceoCheck %}checked="checked"{% endif %} {% if not is_ceo %}disabled{% endif %}>

                            </label>
                            <label class="custom-checkbox">
                              <input hidden type="checkbox" {%if is_ceo%}name="ceoReject"{%endif%}{% if order.ceoReject %}checked="checked"{% endif %} {% if not is_ceo %}disabled{% endif %}>
                              <span class="checkmark"></span>
                            </label>
                          </td>
                          <td>
                            <label class="container">
                              <input type="checkbox" name="financeCheck"
                              
                              {% if order.financeCheck %}checked="checked"{% endif %} 
                              {% if not is_finance or not order.ceoCheck or not order.rightHandCheck or not order.personalAssistantCheck or not order.paymentDate %}disabled{% endif %}>        

                            </label>
                            <label class="custom-checkbox">
                              <input hidden type="checkbox" {%if is_finance%}name="financeReject"{%endif%}{% if order.financeReject %}checked="checked"{% endif %} {% if not is_finance %}disabled{% endif %}>
            
                              <span class="checkmark"></span>
                            </label>
                            </td>
                          <td>
                            <input type="hidden" name="order" value="{{ order.id }}">
                            <input type="hidden" name="order_category" value="{{ order.category }}">
                            <input type="hidden" name="order_company" value="{{ order.company }}">
                            <input type="hidden" name="order_project" value="{{ order.project }}">
                            <a href="{% url 'request_form' order.id order.category order.company order.project %}">Request Form</a>
                          </td>
                          <td>
                            <input type="hidden" name="order" value="{{ order.id }}">
                            <input type="hidden" name="order_category" value="{{ order.category }}">
                            <input type="hidden" name="order_project" value="{{ order.project }}">
                            <a href="{% url 'edit_wo' order.id order.category order.project%}">Edit WO</a>
                          </td>
                          <td>
                            <button type="submit" name="action" value="confirm" class="action-btn" data-orderId = "{{order.id}}" > CONFIRM </button>
                          </td>
                          <td>
                            <button type="submit" name="action" value="reject"class="action-btn" data-orderId="{{order.id}}"> REJECT </button>
                          </td>
    
                          <td>
                            {% if is_pa or is_rightHand or is_ceo or is_finance %}
                              <textarea name="remarksOverview" style="width: 100%;">{{ order.remarksOverview }}</textarea>
                            {% else %}
                              <textarea name="remarksOverview" disabled style="width: 100%;">{{ order.remarksOverview }}</textarea>
                            {% endif %}
                          </td>
                          <td>
                            <input style="width: 80%;" type ="date" id ="dueDate" name ="dueDate" value ="{{order.dueDate |date:'Y-m-d'}}">
                           </td>
                          <td>
                            <input style="width: 80%;" type ="date" id ="paymentDate" name ="paymentDate" value ="{{order.paymentDate |date:'Y-m-d'}}">
                           </td>

                           <td>
                            {% if order.proofOfPayment %}
                            <a href="{{ order.proofOfPayment.url }}">Download Attachment</a>
                            <input style="width: 100%;" type="file" name="proofOfPayment" id="proofOfPayment">
                          {% else %}
                            No attachment
                            <input  style="width: 100%;" type="file" name="proofOfPayment" id="proofOfPayment">
                            <button type="button" onclick="clearFileInput('proofOfPayment')" id="removeButton">Remove</button>
                          {% endif %}
                           </td>
                          <td>
                            <input type="hidden" name="order" value="{{ order.id }}">
                            <button type="submit" name="action" data-orderId="{{order.id}}" class="action-btn" value="delete" onclick="return confirm('Delete Work Order?')" {% if not is_ceo and not is_rightHand and not is_pa %}disabled{% endif %}> DELETE </button>                          
                          
                        </tr>                        
                      </form>
                      {% empty %}
                      <tr>
                        <td>1</td>
                        <td>No work orders available.</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>

                      </tr>
                       {% endfor %}
                    </tbody>
                </table>
              
                  <!-- Pagination Links -->
                  <div class="pagination">
                    <span class="step-links">
                        {% if page_obj.has_previous %}
                            <a href="?page=1">&laquo; first</a>
                            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                        {% endif %}

                        <span class="current">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                        </span>

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}">next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                        {% endif %}
                    </span>
                  </div>
      </div>
    </div>
    <script>
      // Define the function in the global scope so it's always available
      function clearFileInput(id) {
        var input = document.getElementById(id);
        if (input) {
          input.value = "";
        }
      }



        document.querySelectorAll('.action-btn').forEach(button => {
    button.addEventListener('click', function(event) {
      event.preventDefault(); // Prevent the default form submission

      // Find the closest parent row or container
      const parentContainer = this.closest('tr'); // or use '.container-class' if your structure requires
      // Within that container, find the textarea for remarksOverview
      const remarksTextarea = parentContainer.querySelector('textarea[name="remarksOverview"]');

      const paCheck = parentContainer.querySelector('input[type="checkbox"][name="paCheck"]');   
      const rightHandCheck = parentContainer.querySelector('input[type="checkbox"][name="rightHandCheck"]');   
      const ceoCheck = parentContainer.querySelector('input[type="checkbox"][name="ceoCheck"]');   
      const financeCheck = parentContainer.querySelector('input[type="checkbox"][name="financeCheck"]');   
      const paReject = parentContainer.querySelector('input[type="checkbox"][name="paReject"]');   
      const rightHandReject = parentContainer.querySelector('input[type="checkbox"][name="rightHandReject"]');   
      const ceoReject = parentContainer.querySelector('input[type="checkbox"][name="ceoReject"]');   
      const financeReject = parentContainer.querySelector('input[type="checkbox"][name="financeReject"]');   

      const dueDate = parentContainer.querySelector('input[type="date"][name="dueDate"]');
      const paymentDate = parentContainer.querySelector('input[type="date"][name="paymentDate"]');

      const proofOfPayment = parentContainer.querySelector('input[type="file"][name="proofOfPayment"]');
      console.log(proofOfPayment.files[0])
      // Check if the textarea is found and log its value
      if (this.value == "confirm") {

        // Prepare the data for sending in the AJAX request
        const formData = new FormData();
        formData.append('remarksOverview', remarksTextarea.value);
        formData.append('action', this.value); 
        formData.append('orderId', this.getAttribute('data-orderId'));
        if(paCheck) {
          formData.append('paCheck' , paCheck.checked);
        }
        if(ceoCheck) {
          formData.append('ceoCheck' , ceoCheck.checked);
        }
        if(rightHandCheck){
          formData.append('rightHandCheck' , rightHandCheck.checked);
        }
        if(financeCheck) {
          formData.append('financeCheck' , financeCheck.checked);

        }



        formData.append('paymentDate', paymentDate.value);
        formData.append('dueDate', dueDate.value);

        if (proofOfPayment.files[0]) {  // Check if there is at least one file selected
        formData.append('proofOfPayment', proofOfPayment.files[0]);
        }

        console.log(formData)
        // Initialize and send an AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/overview/', true);
        const csrftoken = getCSRFToken();
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.send(formData);

        xhr.onload = function() {
          if (this.status >= 200 && this.status < 300) {
            console.log(this.responseText);
            // Update UI based on response
          } else {
            console.error('Request failed with status: ' + this.status);
          }
        };
      } 
      else if (this.value == "reject"){
        const formData = new FormData();
        formData.append('action', this.value); 
        formData.append('orderId', this.getAttribute('data-orderId'));

        if(paReject){
          formData.append('paReject' , paReject.checked);
        }
        if(ceoReject){
          formData.append('ceoReject' , ceoReject.checked);

        }
        if(rightHandReject){
          formData.append('rightHandReject' , rightHandReject.checked);

        }
        if(financeReject){
          formData.append('financeReject' , financeReject.checked);
        }

        formData.append('remarksOverview', remarksTextarea.value);
        // Initialize and send an AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/overview/', true);
        const csrftoken = getCSRFToken();
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.send(formData);

        xhr.onload = function() {
          if (this.status >= 200 && this.status < 300) {
            console.log(this.responseText);
            // Update UI based on response
          } else {
            console.error('Request failed with status: ' + this.status);
          }
        };
      }
      else {
        const formData = new FormData();
        formData.append('action', this.value); 
        formData.append('orderId', this.getAttribute('data-orderId'));

        // Initialize and send an AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/overview/', true);
        const csrftoken = getCSRFToken();
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.send(formData);

        xhr.onload = function() {
          if (this.status >= 200 && this.status < 300) {
            console.log(this.responseText);
            // Update UI based on response
          } else {
            console.error('Request failed with status: ' + this.status);
          }
        };
      }
    });
  });
  function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Check if the cookie is the CSRF token cookie
            if (cookie.substring(0, 'csrftoken'.length + 1) === ('csrftoken' + '=')) {
                cookieValue = decodeURIComponent(cookie.substring('csrftoken'.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    </script>
  {% else %}
    {% with 'login' as login_url %}
      {% load static %}
      {% load i18n %}
      {% load tz %}

      <script>
  window.location.href = "{% url login_url %}";
      </script>

    {% endwith %}
  {% endif %}
{% endblock %}
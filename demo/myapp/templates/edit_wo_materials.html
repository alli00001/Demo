<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
{% extends 'base.html' %}


{% block content %}
<style>
	/*
	Common invoice styles. These styles will work in a browser or using the HTML
	to PDF anvil endpoint.
*/
.general-information-table {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
td {
  word-wrap: break-word; /* Allows long words to be able to break and wrap onto the next line */
  white-space: normal; /* Allows whitespace to behave normally, i.e., wrapping the text */
}
.general-information-table td {
    padding: 8px;
    vertical-align: middle;
	
}

.general-information-table input[type="text"], 
.general-information-table input[type="date"] {
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #ccc;
    box-sizing: border-box; /* Include padding in width */
	text-align: left;
}

.general-information-table tr:nth-child(even) {
    background-color: #f2f2f2; /* Zebra striping for rows */
}

.general-information-table td:nth-child(1) {
    text-align: left;
    width: 25%;
}

.general-information-table td:nth-child(2) {
    width: 25%;
}

.general-information-table td:nth-child(3), 
.general-information-table td:nth-child(4) {
    text-align: right;
    width: 25%;
}
	.line-items-container {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.line-items-container, .line-items-container th, .line-items-container td {
  border: 1px solid #ddd;
  text-align: center;
  padding: 8px;
}

.line-items-container th {
  background-color: #999;
  color: white;
  text-align: center;
}

.line-items-container select,
.line-items-container input {
    width: 100%; /* Will fill the cell */
    box-sizing: border-box; /* Include padding and border in the width */
}
@media screen and (max-width: 600px) {
  .line-items-container, .line-items-container thead, .line-items-container tbody, .line-items-container th, .line-items-container td, .line-items-container tr {
    text-align: center;
	display: block;
  }

  .line-items-container thead tr {
    text-align: j;
    top: -9999px;
    left: -9999px;
  }

  .line-items-container tr {
    margin: 0 0 1rem 0;
  }

  .line-items-container td {
    border: none;
    position: relative;
    padding-left: 50%;
  }

  .line-items-container td:before {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 45%;
    padding-right: 10px;
    white-space: nowrap;
    content: attr(name);
  }
}

	.payment-info {
		width: 38%;
		font-size: 0.75em;
		line-height: 1.5;
	}

	.footer {
		margin-top: 100px;
	}


	.footer-info {
		float: right;
		margin-top: 5px;
		font-size: 0.75em;
		color: #ccc;
	}

	.footer-info span {
		padding: 0 5px;
		color: black;
	}

	.add-new-button {
		background-color: white;
		border: 2px solid #008CBA;
	}

	.add-new-button:hover {
		background-color: #008CBA;
		color: white;
	}

	.payment-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.payment-table, .payment-table th, .payment-table td {
  border: 1px solid #ddd;
  text-align: left;
  padding: 8px;
}

.payment-table th {
  background-color: #999;
  color: white;
}

.payment-table td input[type="text"], .payment-table td select {
  width: 100%;
  padding: 5px;
  margin: 4px 0;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
}


@media screen and (max-width: 600px) {
  .payment-table, .payment-table thead, .payment-table tbody, .payment-table th, .payment-table td, .payment-table tr {
    display: block;
  }

  .payment-table thead tr {
    position: absolute;
    top: -9999px;
    left: -9999px;
  }

  .payment-table tr {
    margin: 0 0 1rem 0;
  }

  .payment-table td {
    border: none;
    position: relative;
    padding-left: 50%;
  }

  .payment-table td:before {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 45%;
    padding-right: 10px;
    white-space: nowrap;
  }

  .payment-table td:nth-of-type(1):before { content: "PAYMENT"; }
  .payment-table td:nth-of-type(2):before { content: "PERCENTAGE"; }
  .payment-table td:nth-of-type(3):before { content: "AMOUNT"; }
  .payment-table td:nth-of-type(4):before { content: "REMARKS"; }
}



</style>

<form id="workOrder" , method="post" enctype="multipart/form-data">
	{%csrf_token%}
	{% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
{% endif %}
<div style="text-align: center; background-color: white">
    {% if order.company == 'aci' %}
        <img src="{{ MEDIA_URL }}aci_cmp_logo2.jpg" style="width: 400px;">
		<input type="hidden" value="aci"  name ="company" id ="company">
    {% elif order.company == 'bks' %}

        <img src="{{ MEDIA_URL }}bks4.png">
		<input type="hidden" value="bks"  name ="company" id ="company">
    {% else %}

    <img src="{{ MEDIA_URL }}lki_cmp_logo2.jpg" style="width: 400px;"> <!-- Same width for consistency -->
		<input type="hidden" value="lki"  name ="company" id ="company">
    {% endif %}
</div>
	<!-- Title Text -->

	<div style="text-align: center; font-size: 2.0em;">
		<b>
			{% if order.company == 'aci' %}
				PT. ANSINDA COMMUNICATION INDONESIA
        {% elif order.company == 'bks' %}
				PT. BAHTERA KONSTRUKSI SEJAHTERA
        {% else %}
				PT. LEONY KONSTRUKSKI INDONESIA
			{% endif %}
		</b>
	</div>
	<div style="text-align: center; font-size: 2.5em;">
		<b>WORK ORDER</b>
	</div>
	<table class = "general-information-table"  >
		<tr>
			<td style="width: 18%;">DATE</td>
			<td style="width: 2%; text-align: center;">:</td>
			<td style="width: 20%; text-align: left;" ><input type ="date" name="wo_date" id ="wo_date" type="date" style="text-align: left; height: 30px" value="{{ order.wo_date|date:'Y-m-d' }}"/></td>
			
			<td style ="width:10%"></td>

			<td style ="width:18%">WO NUMBER</td>
			<td style="width: 2%;">:</td>
			{% if order.company == 'aci' %}
			<td style ="width:30%">WO / ACI / EMR / <input name ="shortdate"  value="{{order.shortdate}}" id ="shortdate" type ="text" style="width: 10%; height: 30px; text-align: center;" readonly> / <input name="wo_number" id = "wo_number" value="{{order.wo_number}}" type="number" style="text-align: right; height: 30px; width: 20%;" min = "0" max = "9999" maxlength="4"></td>
      		{% elif order.company == 'bks' %}
			<td style ="width:30%">WO / BKS / EMR / <input name ="shortdate" id ="shortdate"  value="{{order.shortdate}}" type ="text" style="width: 10%; height: 30px; text-align: center;" readonly> / <input name="wo_number" id = "wo_number" value="{{order.wo_number}}"	 type="number" style="text-align: right; height: 30px; width: 20%;" min = "0" max = "9999" maxlength="4"></td>
      		{% else %}
			<td style ="width:30%">WO / LKI / EMR / <input name ="shortdate" id ="shortdate"  value="{{order.shortdate}}" type ="text" style="width: 10%; height: 30px; text-align: center;" readonly> / <input name="wo_number" id = "wo_number" value="{{order.wo_number}}"	 type="number" style="text-align: right; height: 30px; width: 20%;" min = "0" max = "9999" maxlength="4"></td>
      		{% endif %}		
		</tr>
		<tr>
			<td style="width: 18%;">REQUEST BY</td>
			<td style="width: 2%; text-align: center;">:</td>
			<td style="width: 20%; text-align: left;"><input text-transform: uppercase; value="{{order.request_by}}" name="request_by" type="text" style="text-align: left; height: 30px;"></td >
			<td style ="width:20%">
				
			<td>CATEGORY</td>
			<td style="width: 2%;">:</td>
			<td style ="width:20%"><input value="{{order.category}}" name="category" type="text" style="text-align: left; height: 30px;" value="MP"></td>
		</tr>
		<tr>
			<td style="text-align: left; width: 25px;">PROJECT</td>
			<td>:</td>
			<td style="text-align: left;"><input  value="{{order.project}}" name="project" type="text" style=" height : 30px" value="EMR"> </strong></td>
			<td></td>

			<td>BANK</td>
			<td>:</td>
			<td style="text-align: left;"><select id ="bank" name="bank"style="text-align: left; height: 30px; width: 100%;">
                <option value="BCA" {% if order.bank == 'BCA' %}selected{% endif %}>BCA</option>
                <option value="MANDIRI" {% if order.bank == 'MANDIRI' %}selected{% endif %}>MANDIRI</option>
                <option value="OCBC NISP" {% if order.bank == 'OCBC NISP' %}selected{% endif %}>OCBC</option>
                <option value="BRI" {% if order.bank == 'BRI' %}selected{% endif %}>BRI</option>
				<option value="CREATE">CREATE</option>

			</td>
		</tr>
		<tr>
			<td style="text-align: left;">CUSTOMER</td>
			<td>:</td>
			<td style="text-align: left;">
				<select id ="customer"name="customer" style="height : 30px ; width:100%;">
					<option value = "ZTE"  {% if order.customer == 'ZTE' %}selected{% endif %}>ZTE</option>
					<option value = "YOFC"  {% if order.customer == 'YOFC' %}selected{% endif %}>YOFC</option>
					<option value = "FH"  {% if order.customer == 'FH' %}selected{% endif %}>FH</option>
					<option value="CREATE">CREATE</option>
			</td>

			<td></td>

			<td style="text-align: left;height: 30px;">ACCOUNT NAME</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.account_name}}" name="account_name" type="text" style="height : 30px ;"></td>
		</tr>
		<tr>
			<td style="text-align: left; width: 25px;">DEPARTMENT</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.department}}" name="department" type="text" style=" height : 30px" value="PROJECT"></td>

			<td></td>

			<td style="text-align: left">ACCOUNT NUMBER</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.account_number}}" name="account_number" type="text" style="height : 30px"></td>
		</tr>
		<tr>
			<td style="text-align: left; width: 25px;">REGION</td>
			<td>:</td>
			<td style="text-align: left;"><select id ="region" name="region" style=" height : 30px ;width: 100% ;">
				<option value="JABO"  {% if order.region == 'JABO' %}selected{% endif %}>JABO</option>
				<option value="CJ"  {% if order.bank == 'CJ' %}selected{% endif %}>CJ</option>
				<option value="EJ"  {% if order.bank == 'EJ' %}selected{% endif %}>EJ</option>
				<option value="WJ"  {% if order.bank == 'WJ' %}selected{% endif %}>WJ</option>
				<option value="CREATE">CREATE</option>

			</td>

			<td></td>

			<td style="text-align: left">PHONE NUMBER</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.phone_number}}" name="phone_number" type="text" style="height : 30px"></td>
		</tr>
		<tr>
			<td style="text-align: left; width: 25px;">CITY</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.city}}" name="city" type="text" style=" height : 30px"></td>

			<td></td>

			<td style="text-align: left">NPWP</td>
			<td>:</td>
			<td style="text-align: left;"><input value="{{order.npwp}}" name="npwp" type="text" style="height : 30px"></td>
		</tr>
	</table>

    {%if order.project == 'EMR'%}
	<div class="table-container">
		<table class="line-items-container">
			<thead>
				<tr>
					<th class="heading-description" style ="width : 20%" >CLUSTER NAME</th>
					<th class="heading-description" style ="width : 20%">SITE ID</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><textarea style="width: 100%;" class="clusterName" name="clusterName">{{order.clusterName}}</textarea></td>
					<td><textarea style="width: 100%;" class="siteId" name="siteId">{{order.siteId}}</textarea></td>

				</tr>
			</tbody>
		</table>
	</div>

    {%else%}
    <div class="table-container">
		<table class="line-items-container">
			<thead>
				<tr>
					<th class="heading-description" style ="width : 20%" >CLUSTER NAME</th>
					<th class="heading-description" style ="width : 20%">ODB ID</th>
                    <th class="heading-description" style ="width : 20%">SUFFIX ID</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><textarea style="width: 100%;" class="clusterName" name="clusterName">{{order.clusterName}}</textarea></td>
					<td><textarea style="width: 100%;" class="odbId" name="odbId"></textarea>{{order.odbId}}</td>
					<td><textarea style="width: 100%;" class="suffixId" name="suffixId">{{order.suffixId}}</textarea></td>
				</tr>
			</tbody>
		</table>
	</div>
    {%endif%}

	
	<button class="button add-new-button" onclick=add() type="button">+</button>
	<table class="line-items-container" id="scopeOfWork" >
		<thead>
			<tr>
				<th style ="width : 4%">NO</th>
				<th style ="width: 21%;">ITEM</th>
				<th style ="width : 12,5%">UNIT</th>
				<th style ="width : 12,5%">QTY</th>
				<th style ="width : 12,5%">UNIT PRICE</th>
				<th style ="width : 12,5%">AMOUNT</th>
				<th style ="width : 25%">REMARKS</th>
				<th style ="width : 0%;"></th>
			</tr>
		</thead>
		<tbody>
            {%for scope in order.workOrder.all%}
            {% if order.project == 'EMR'%}
            <tr>
                <td style = "text-align: center;" class="line-items-container">{{ forloop.counter }}</td> <!-- This will auto-increment the row number -->
                <td style="text-align: left;"><select style="text-align: left;" class="line-items-container" name ="scopeOfWork_{{ forloop.counter|add:"-1" }}">
					<option value="Clamp Pole Single 2,5 inch" data-price="9000" {% if scope.scopeOfWork == 'Clamp Pole Single 2,5 inch' %}selected{% endif %}>Clamp Pole Single 2,5 inch</option>
					<option value="Dead End Fitting / Fixed / clamp Buaya 25/50" data-price="13000" {% if scope.scopeOfWork == 'Dead End Fitting / Fixed / clamp Buaya 25/50' %}selected{% endif %}>Dead End Fitting / Fixed / clamp Buaya 25/50</option>
					<option value="Stopping M6" data-price="500" {% if scope.scopeOfWork == 'Stopping M6' %}selected{% endif %}>Stopping M6</option>
					<option value="Clamp 8 (Clamp Gantung)" data-price="12500" {% if scope.scopeOfWork == 'Clamp 8 (Clamp Gantung)' %}selected{% endif %}>Clamp 8 (Clamp Gantung)</option>
					<option value="Suspension Corong" data-price="14000" {% if scope.scopeOfWork == 'Suspension Corong' %}selected{% endif %}>Suspension Corong</option>
					<option value="Span Wartel M10" data-price="8000" {% if scope.scopeOfWork == 'Span Wartel M10' %}selected{% endif %}>Span Wartel M10</option>
					<option value="Plat Belt 20mm / Stainless Belt" data-price="135000" {% if scope.scopeOfWork == 'Plat Belt 20mm / Stainless Belt' %}selected{% endif %}>Plat Belt 20mm / Stainless Belt</option>
					<option value="Buldog Grip M8" data-price="7500" {% if scope.scopeOfWork == 'Buldog Grip M8' %}selected{% endif %}>Buldog Grip M8</option>
					<option value="Steel Clamp" data-price="12000" {% if scope.scopeOfWork == 'Steel Clamp' %}selected{% endif %}>Steel Clamp</option>
					<option value="Helical SET 24 Core" data-price="7800" {% if scope.scopeOfWork == 'Helical SET 24 Core' %}selected{% endif %}>Helical SET 24 Core</option>
					<option value="Helical SET 144 Core" data-price="18000" {% if scope.scopeOfWork == 'Helical SET 144 Core' %}selected{% endif %}>Helical SET 144 Core</option>
					<option value="Helical SET 288 Core" data-price="20000" {% if scope.scopeOfWork == 'Helical SET 288 Core' %}selected{% endif %}>Helical SET 288 Core</option>
					<option value="Bracket A (for Helical Dead End)" data-price="4500" {% if scope.scopeOfWork == 'Bracket A (for Helical Dead End)' %}selected{% endif %}>Bracket A (for Helical Dead End)</option>					
                </select></td>
                <td><input class="line-items-container" type="text" name ="unit_{{ forloop.counter|add:"-1" }}" value="{{ scope.unit }}"></td>
                <td><input class="line-items-container" type="number" name ="qtyA_{{ forloop.counter|add:"-1" }}" value="{{ scope.qtyActual }}"></td>
                <td><input class="line-items-container" type ="text"name ="unitPrice_{{ forloop.counter|add:"-1" }}" value="{{ scope.unitPrice }}"></td>
                <td><input class="line-items-container" type="text" name ="totalA_{{ forloop.counter|add:"-1" }}" value="{{ scope.totalActual }}"></td>
                <td><input class="line-items-container" type="text" name ="remarks_{{ forloop.counter|add:"-1" }}" value="{{ scope.remarks }}"></td>
                <td><button class ="button add-new-button removeRowButton" id ="removeRow" >-</button></td>      
                </tr> 
            {% else%}
            <tr>
                <td style = "text-align: center;" class="line-items-container">{{ forloop.counter }}</td> <!-- This will auto-increment the row number -->
                <td style="text-align: left;"><select style="text-align: left;" class="line-items-container" name ="scopeOfWork_{{ forloop.counter|add:"-1" }}">
					<option value="Clamp Pole 2,5 inch Linknet Standard" data-price="12000" {% if scope.scopeOfWork == 'Clamp Pole 2,5 inch Linknet Standard' %}selected{% endif %}>Clamp Pole 2,5 inch Linknet Standard</option>
					<option value="Stopping M6" data-price="500" {% if scope.scopeOfWork == 'Stopping M6' %}selected{% endif %}>Stopping M6</option>
					<option value="Span Wartel M10" data-price="8000" {% if scope.scopeOfWork == 'Span Wartel M10' %}selected{% endif %}>Span Wartel M10</option>
					<option value="Buldog Grip M8" data-price="7500" {% if scope.scopeOfWork == 'Buldog Grip M8' %}selected{% endif %}>Buldog Grip M8</option>									
                </select></td>
                <td><input class="line-items-container" type="text" name ="unit_{{ forloop.counter|add:"-1" }}" value="{{ scope.unit }}"></td>
                <td><input class="line-items-container" type="number" name ="qtyA_{{ forloop.counter|add:"-1" }}" value="{{ scope.qtyActual }}"></td>
                <td><input class="line-items-container" type ="text"name ="unitPrice_{{ forloop.counter|add:"-1" }}" value="{{ scope.unitPrice }}"></td>
                <td><input class="line-items-container" type="text" name ="totalA_{{ forloop.counter|add:"-1" }}" value="{{ scope.totalActual }}"></td>
                <td><input class="line-items-container" type="text" name ="remarks_{{ forloop.counter|add:"-1" }}" value="{{ scope.remarks }}"></td>
                <td><button class ="button add-new-button removeRowButton" id ="removeRow" >-</button></td>      
                </tr> 
            {%endif%}
              {%endfor%}
		</tbody>
		<tfoot>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td id="grand-total-actual"><input type = "text" name ="grand-total-actual" value = "{{order.grandTotalActual}}"></td>
				<td></td>
				<td></td>
			</tr>
		</tfoot>
	</table>


  <!-- PAYMENT -->
  <div style="margin-top: 50px;">
    <button class="button add-new-button" onclick=addDeduction() type="button">+</button>
    <table class="line-items-container" id ="payment-table" border="1">
      <thead>
        <th style ="width : 25%">PAYMENT</th>
        <th style ="width : 25%">PERCENTAGE</th>
        <th style ="width : 25%">AMOUNT</th>
        <th style ="width : 25%">REMARKS</th>
      </thead>
      <tbody>
        <tr>
          <td>TOTAL</td>
          <td></td>
          <td id ="grand-total-payment"> <input type = "text" name ="grand-total-payment" value = "{{order.totalAmount}}"></td>
          <td><input type ="text" name ="remarks1" value ="{{order.remarks1}}"></td>
        </tr>
        <tr>
          <td>
            <select name = "terms-selection" id ="terms-selection">
                <option value = "DP" data-percentage-amount =30% data-remarks = '' {% if order.paymentTerm == 'DP' %}selected{% endif %}> DP </option>
                <option  value ="TERM 2" data-percentage-amount =40%  data-remarks = 'Implementation Done' {% if order.paymentTerm == 'TERM 2 - Implementation Done' %}selected{% endif %}>TERM 2</option>
                <option  value ="TERM 3" data-percentage-amount =20% data-remarks = 'ATP Done' {% if order.paymentTerm == 'TERM 3 - ATP Done' %}selected{% endif %}>TERM 3</option>
                <option  value ="TERM 4" data-percentage-amount =10% data-remarks = 'FAC Done' {% if order.paymentTerm == 'TERM 4 - FAC Done' %}selected{% endif %}>TERM 4</option>
                <option  value ="CASHBON" data-percentage-amount =0% data-remarks = '' {% if order.paymentTerm == 'CASHBON' %}selected{% endif %}>CASHBON</option>
                <option  value ="FULL" data-percentage-amount = 100% data-remarks = '' {% if order.paymentTerm == 'FULL' %}selected{% endif %} >FULL</option>
                <option  value ="REMAINING" data-percentage-amount =0% data-remarks = ''  {% if order.paymentTerm == 'REMAINING' %}selected{% endif %}>REMAINING</option>
                <option  value ="CREATE" data-percentage-amount = 0% data-remarks = '' >CREATE</option>  
            </select>
            </td>
			<td><input type="text" id="terms-percentage-cell" name="terms-percentage-cell" value="{{order.termPercentage}}"></td>          
			<td id = "terms-amount-cell"><input type="text" id="terms-amount-cell" name="terms-amount-cell"value="{{order.termAmount}}"></td>
          <td style = "text-align: left;">
			<input type ="text" name ="payment-remarks-cell" value="{{order.termRemark}}">
		  </td>
        </tr>
        <tr>
          <td>
			<select name ="tax-cell" id ="tax-cell">
				<option value ="WHT-21" data-tax-percentage-amount = 2.5% {% if order.paymentTax == 'WHT-21' %}selected{% endif %}>TAX - WHT21</option>
				<option value ="WHT-23" data-tax-percentage-amount = 2% {% if order.paymentTax == 'WHT-23' %}selected{% endif %}>TAX - WHT23</option>
				<option value ="VAT" data-tax-percentage-amount = 11% {% if order.paymentTax == 'VAT' %}selected{% endif %}>TAX - VAT</option>
			</select>
		</td>
          <td>
			<input type="text" id="tax-percentage-cell" name="tax-percentage-cell"  value="{{order.taxPercentage}}">       
		  </td>
          <td id = "tax-amount-cell"> <input type="text" id="tax-amount-cell" name="tax-amount-cell"value="{{order.taxAmount}}"></td>
          <td style = "text-align: left;"	>
			<input type ="text" name ="tax-remarks-cell" value="{{order.taxRemark}}">
		  </td>
        </tr>
        {% if order.deductions.all %}
		{% with total_deductions=order.deductions.all.count %}
		{% for deduction in order.deductions.all %}
			{% with reversed_index=forloop.revcounter0 %}
			<tr id="deduction-row" class="deduction-row">
				<td>
					<select name="deduction_{{ reversed_index }}">
						<option value="DEDUCTION" {% if deduction.deductOrAddition == 'DEDUCTION' %}selected{% endif %}>DEDUCTION</option>
						<option value="ADDITION" {% if deduction.deductOrAddition == 'ADDITION' %}selected{% endif %}>ADDITION</option>
					</select>
				</td>
				<td>
					<input type="text" name="deduction-percentage_{{ reversed_index }}" style="display: none;">
				</td>
				<td>
					<input type="text" value="{{ deduction.deductionAmount }}" name="ded-addition-amount-cell_{{ reversed_index }}" id="ded-addition-amount-cell_{{ reversed_index }}">
				</td>
				<td>
					<input type="text" value="{{ deduction.deductionRemarks }}" name="deduction-remarks_{{ reversed_index }}" id="deduction-remarks_{{ reversed_index }}">
				</td>
				<td>
					<button class="button add-new-button removeRowDed" id="removeRowDed" style="width: 25px;">-</button>
				</td>       
			</tr>
			{% endwith %}
		{% endfor %}
	{% endwith %}
        {% else %}
        <tr id="deduction-row" class="deduction-row">
        </tr>
    {% endif %}

      </tbody>
      <tfoot>
        <tr>
          <td> GRAND TOTAL </td>
          <td></td>
          <td id = "grand-total-payment2"><input type = "text" name ="grand-total-payment2" value = "{{order.finalGrandTotal}}"></td>
          <td><input type ="text" name ="remarks2" value="{{order.remarks2}}"></td>
        </tr>
      </tfoot>
    </table>
  </div>

      <!-- TERM PAYMENT -->
<button class="button add-new-button" onclick=addPayment() type="button">+</button>
<table class="line-items-container"border="1"  id = "paymentTable" name ="paymentTable">	
  <thead>
	<th>PAYMENT TYPE</th>
	<th>PERCENTAGE</th>
	<th>AMOUNT</th>
	<th>STATUS</th>
	<th>DATE</th>
	<th style ="width : 0%;"></th>
  </thead>
  <tbody>
	  {% for paymentType in order.paymentInformation.all%}
	  <tr>
		  <td >  <input type = "text" name ="pType_{{ forloop.counter|add:"-1" }}" value = "{{paymentType.pType}}"></td>
		  <td ><input type = "text" name ="pPercentage_{{ forloop.counter|add:"-1" }}"  value = "{{paymentType.pPercentage}}"></td>
		  <td > <input type = "text" name ="pAmount_{{ forloop.counter|add:"-1" }}"  value = "{{paymentType.pAmount}}"></td>
		  <td>
			<select name ="pStatus_{{ forloop.counter|add:"-1" }}">
				<option value ="DONE" {% if paymentType.pStatus == 'DONE' %}selected{% endif %}>DONE</option>
				<option value ="REQUEST"{% if paymentType.pStatus == 'REQUEST' %}selected{% endif %}>REQUEST</option>
			</select>
		  </td>
		  <td ><input type = "date" name ="pDate_{{ forloop.counter|add:"-1" }}"  value = "{{paymentType.pDate |date:'Y-m-d' }}"></td>
		  <td><button class="button add-new-button removeRowPayment" id="removeRowPayment" style="width: 25px;">-</button>
		  </td>
	  </tr>
	{%endfor%}
  </tbody>
</table>
  
  <!-- DOCUMENT -->
  <table class="line-items-container"border="1">
    <thead>
      <th>DOCUMENT</th>
	  <th>STATUS</th>
    </thead>
	<tbody>
		<tr>
			<td>INVOICE</td>
			<td>
				{% if order.invoice %}
					<a href="{{ order.invoice.url }}">Download Attachment</a>
					<input type="file" name="invoice">
				{% else %}
					No attachment
					<input type="file" name="invoice">
				{% endif %}
			</td>
		</tr>
	</tbody>
  </table>

  <!-- SIGN FIELD -->
  {% if order.company == 'aci' %}
  {% if order.project == 'EMR' %}
    <table class="line-items-container">
      <thead>
        <th>CREATED BY</th>
        <th colspan="2" style="text-align: center;">APPROVED BY</th>
      </thead>
      <tbody>
        <tr>
          <td style="height: 200px;">
          <td></td>
		  <td></td>
        </tr>
        <tr>
          <td><u>AGUNG SONATA</u></td>
          <td><u>TONY</u></td>
          <td><u>STEVEN</u></td>
        </tr>
        <tr>
          <td>PROCUREMENT</td>
          <td></td>
          <td>CEO</td>
        </tr>
      </tbody>
    </table>
  {% if order.project == 'LN' %}
    <table class="line-items-container">
      <thead>
        <th>CREATED BY</th>
        <th colspan="2" style="text-align: center;">APPROVED BY</th>
      </thead>
      <tbody>
        <tr>
          <td style="height: 200px;"></td>
          <td></td>
        </tr>
        <tr>
          <td><u>AGUNG SONATA</u></td>
          <td><u>SUNNY</u></td>
          <td><u>STEVEN</u></td>
        </tr>
        <tr>
          <td>PROCUREMENT</td>
          <td></td>
          <td>CEO</td>
        </tr>
      </tbody>
    </table>
  {% endif %}
{% endif %}
{% elif order.company == 'bks' %}

<table class="line-items-container">
<thead>
	<th>CREATED BY</th>
	<th>APPROVED BY</th>
</thead>
<tbody>
	<tr><td style="height: 200px;"><td></td></td></tr>
	<tr><td><u>ELSA MONICA</u></td><td><u>JENNY</u></td></tr>
	<tr><td>PROCUREMENT</td><td>CEO</td></tr>

</tbody>
</table>
{%else%} 
<table class="line-items-container">
<thead>
	<th>CREATED BY</th>
	<th>APPROVED BY</th>
</thead>
<tbody>
	<tr><td style="height: 200px;"><td></td></td></tr>
	<tr><td><u>AGUNG</u></td><td><u>FERONIA</u></td></tr>
	<tr><td>PROCUREMENT</td><td>CEO</td></tr>

</tbody>
</table>
{%endif%}


	<div class="footer">
		<div class="footer-info">
		</div>
	</div>

	<div>
		<button type="submit" id ="submitBtn"> Submit </button>
	</div>

	
	<input type="number" id="number_of_scopes" name="number_of_scopes" value="{{ order.scopeOfWorkCount }}" style="display: none;" >
	<input type="number" id="number_of_deduction" name="number_of_deduction" value="{{ order.deductionCount }}"  style="display: none;" >
	<input type="number" id="number_of_payment" name="number_of_payment" value="{{order.paymentCount}}" style="display: none;">

	<input type = "text" id = "pricing_type" name ="pricing_type" value ="{{order.pricing_type}}" style="display: none;">

</form>
<script type="text/javascript">
    var pricingType = "{{ order.pricing_type }}";
</script>



<script type="text/javascript">

	document.addEventListener("DOMContentLoaded", function(){
            document.getElementById("submitBtn").addEventListener("click", function(e){
                var woNumber = document.getElementById("wo_number").value;
                if (!woNumber) {
                    alert("The work order number cannot be empty.");
                    e.preventDefault(); // Prevent form submission
                }
            });
        });
</script>

<script>

function updateTotalActual(number){
    const qtyAElement = document.querySelector(`input[name='qtyA_${number}']`);
    const unitPriceElement = document.querySelector(`input[name='unitPrice_${number}']`);
    const totalAElement = document.querySelector(`input[name='totalA_${number}']`);
    
    const qtyA = parseFloat(qtyAElement.value) || 0;
    const unitPrice = parseFloat(unitPriceElement.value) || 0;
    
    const totalA = qtyA * unitPrice;
    totalAElement.value = totalA.toFixed(2);
}

document.addEventListener('DOMContentLoaded', (event) => {
    document.body.addEventListener('change', function(event) {
        // Check if the changed element's name starts with 'scopeOfWork_'
        if (event.target.name && event.target.name.startsWith('scopeOfWork_')) {
            // Extract the number from the name
            const number = event.target.name.split('_')[1];
            // Get the selected option and its data-price attribute
            const selectedOption = event.target.options[event.target.selectedIndex];
            const dataPrice = selectedOption.getAttribute('data-price');
            
            // Check if dataPrice is a valid number before setting it
            if (dataPrice && !isNaN(dataPrice)) {
                // Find the corresponding unit price input and update its value
                const unitPriceElement = document.querySelector(`input[name='unitPrice_${number}']`);
                unitPriceElement.value = dataPrice;

                // After updating the unit price, you may want to update totals as well
                updateTotalActual(number);
				updateTotals();
				termsAmountCalculation();
				taxAmountCalculation();
				updateGrandTotal();
            }
        }
    });
});
document.addEventListener('input', function(event) {
    const target = event.target;
    const name = target.name;
    
    if (name) {
        let number = '';
        if (name.startsWith('qtyA_')) {
            number = name.split('_')[1];
            updateTotalActual(number);
        }else if (name.startsWith('unitPrice_')) {
            number = name.split('_')[1];
            // Update both totals since unit price affects both
            updateTotalActual(number);
        } else if (name.startsWith('ded-addition-amount')){
			updateGrandTotal()
		}
    }
});

function termsAmountCalculation() {
  var selection = document.getElementById('terms-selection');
  var selectedOption = selection.options[selection.selectedIndex];

  // Get the percentage either from the dropdown or from the custom input
  var percentageInput = document.getElementById('terms-percentage-cell').value;
  var percentageString = percentageInput !== '' ? percentageInput : selectedOption.getAttribute('data-percentage-amount');
  
  // Remove any non-numeric characters (e.g., '%') and parse the percentage
  var cleanedPercentageString = percentageString.replace('%', '');
  var percentageNumber = parseFloat(cleanedPercentageString) / 100;

  // Retrieve the grand total value
  var grTotalCell = document.getElementById('grand-total-payment').querySelector('input').value;
  var grValue = parseFloat(grTotalCell) || 0;

  // Calculate and update the terms amount
  var calculatedAmount = percentageNumber * grValue;
  document.getElementById('terms-amount-cell').querySelector('input').value = calculatedAmount.toFixed(2);
  document.getElementById('terms-percentage-cell').value= percentageString;

}

function taxAmountCalculation(){
  var selection = document.getElementById('tax-cell');
  var selectedOption = selection.options[selection.selectedIndex];

  // Get the percentage either from the dropdown or from the custom input
  var percentageInput = document.getElementById('tax-percentage-cell').value;
  var percentageString = percentageInput !== '' ? percentageInput : selectedOption.getAttribute('data-percentage-amount');
  
  // Remove any non-numeric characters (e.g., '%') and parse the percentage
  var cleanedPercentageString = percentageString.replace('%', '');
  var percentageNumber = parseFloat(cleanedPercentageString) / 100;

  // Retrieve the grand total value
  var termAmoutCell = document.getElementById('terms-amount-cell').querySelector('input').value;
  var termAmoutCellValue = parseFloat(termAmoutCell) || 0;

  // Calculate and update the terms amount
  var calculatedAmount = percentageNumber * termAmoutCellValue;
  document.getElementById('tax-amount-cell').querySelector('input').value = calculatedAmount.toFixed(2);
}

function addDeduction(){
  var paymentTable = document.getElementById('payment-table')
  var deductionRow = document.getElementById('deduction-row')
  var rowIdx = deductionRow.rowIndex
  var newRow = paymentTable.insertRow(rowIdx)
  var number_of_deduction = document.getElementById('number_of_deduction'); 
  var currentCount = parseInt(number_of_deduction.value, 10) || 0; 
  for (i = 0 ; i < 5 ; i++){
	var cell = newRow.insertCell(i);
	if (i == 0){
		var selection = document.createElement('select')
		selection.name = "deduction_" + currentCount.toString()
		var option1 = document.createElement("option");
		option1.value = "DEDUCTION";
		option1.text = "DEDUCTION";
		selection.appendChild(option1);

		var option2 = document.createElement("option");
		option2.value = "ADDITION";
		option2.text = "ADDITION";
		selection.appendChild(option2);
		cell.appendChild(selection)
	}
	if (i == 1){
		var percentage_cell = document.createElement('input')
		percentage_cell.type = 'text'
		percentage_cell.name = 'deduction-percentage_' +currentCount.toString()
		percentage_cell.style.display = 'none'
		cell.appendChild(percentage_cell)
	}
	if (i == 2){
		var amount_cell = document.createElement('input')
		amount_cell.type = 'text'
		amount_cell.name = 'ded-addition-amount-cell_' + currentCount.toString()
		amount_cell.id = 'ded-addition-amount-cell_' + currentCount.toString()
		amount_cell.value = 0
		cell.appendChild(amount_cell)
		
	}
	if (i == 3){
		var remarks_cell = document.createElement('input')
		remarks_cell.type = 'text'
		remarks_cell.name = 'deduction-remarks_' + currentCount.toString()
		cell.style.textAlign = 'left'
		cell.appendChild(remarks_cell)
	}
	if (i == 4) {
		var removeButton = document.createElement("button");
		removeButton.id = "removeRowDed"
		removeButton.className = "button add-new-button removeRowDed"
		removeButton.style.width = "25px"
		removeButton.textContent = "-"
		cell.appendChild(removeButton)
	}
    newRow.dataset.index = currentCount; // Set the new top row index
    number_of_deduction.value = (currentCount + 1).toString(); // Increment for the next new row
    // Now re-index all rows
    reIndexRowsDed('payment-table'); 
    }
}
document.addEventListener('keypress', function(event) {
    // Check if the Enter key is pressed without the Shift key
    if (event.keyCode === 13 && !event.shiftKey) {
        // Check if the target of the keypress event is not a textarea
        if (event.target.tagName.toLowerCase() !== 'textarea') {
            event.preventDefault();
            return false;
        }
    }
});


function addUppercaseListener(element) {
  element.addEventListener('input', function() {
    this.value = this.value.toUpperCase();
  });
}

function updateGrandTotal() {
    var grandTotal = 0;

    // Select all input elements with an ID containing 'amount-cell'
    var amountInputs = document.querySelectorAll('input[id*="amount-cell"]');
    amountInputs.forEach(function(input) {
        // Parse the value of each input as a float
        var value = parseFloat(input.value) || 0;
				
		        // Check if the ID is 'tax-amount-cell'
		if (input.id === 'tax-amount-cell') {
            // Subtract the tax amount from the total
            grandTotal -= value;
        } else {
            // Add the value to the total for other IDs
            grandTotal += value;
        }
    });

    // Update the grand total in the appropriate input field
	document.getElementById('grand-total-payment2').querySelector('input').value = grandTotal.toFixed(2);
}
function updateTotals() {
	var totalActual = 0;
	
	var rows = document.querySelectorAll("#scopeOfWork tbody tr");
	rows.forEach(function(row) {
		var actual = row.querySelector('[name^="totalA"]'); // Use the correct selector for your inputs
		
		// Add the parsed values to the totals, ensuring they are numbers
		totalActual += actual ? parseFloat(actual.value) || 0 : 0;
    
	});
	document.getElementById("grand-total-actual").querySelector('input').value = totalActual
    document.getElementById("grand-total-payment").querySelector('input').value = totalActual
}

function reIndexRows(tableId) {
  var table = document.getElementById(tableId);
  var rows = table.querySelectorAll('tbody tr');

  // Start from 0 since we're iterating over tbody rows directly
  rows.forEach(function(row, index) {
    var newIndex = index;
    row.dataset.index = newIndex; // Update the dataset index
    var numberCell = row.cells[0]; // Update the visible row number
    numberCell.textContent = newIndex + 1;

    // Update the names of all input/select elements
    var inputs = row.querySelectorAll('input, select');
    inputs.forEach(function(input) {
      var name = input.name;
      if (name) {
        // Replace the old index with the new one
        input.name = name.replace(/_\d+$/, '_' + newIndex);
      } 
    });
  });
}
function reIndexRowsDed(tableId) {
  var table = document.getElementById(tableId);
  var rows = table.querySelectorAll('tr.deduction-row');
  var startingIndex = rows.length - 1; // Start with the highest index
  
  rows.forEach(function(row, index) {
    var newIndex = startingIndex - index; // Assign indices starting from the top
    row.dataset.index = newIndex; // Update the dataset index

    // Update the names of all input/select elements
    var inputs = row.querySelectorAll('input, select');
    inputs.forEach(function(input) {
      var name = input.name;
      if (name) {
        var match = name.match(/^(deduction_)(\d+)$/); // Assuming the format is "deduction_#"
        if (match) {
          input.name = match[1] + newIndex; // Replace with the new index
        }
      }
    });
  });
}
function reIndexRowsPayment(tableId) {
    var table = document.getElementById(tableId);
    var rows = table.querySelectorAll('tbody tr');
  rows.forEach(function(row, index) {
    var newIndex = index; 
    row.dataset.index = newIndex; // Update the dataset index

    // Update the names of all input/select elements
    var inputs = row.querySelectorAll('input, select');
    inputs.forEach(function(input) {
      var name = input.name;
      if (name) {
        // Replace the old index with the new one
        input.name = name.replace(/_\d+$/, '_' + newIndex);
      } 
    });
  });
}
var woProject = "{{ order.project }}";
function addPayment(){
	var paymentTable =  document.getElementById("paymentTable");
	var tbody = paymentTable.tBodies[0]
	var rows = tbody.rows.length;
	var r = tbody.insertRow(rows); // Insert the row at the end of this tbody
	var number_of_payment = document.getElementById("number_of_payment");
	var currentCount = parseInt(number_of_payment.value, 10)
	number_of_payment.value = currentCount + 1
	r.dataset.index = currentCount ;	

	for(var i = 0 ; i < 6 ;i++){
		var cell = r.insertCell(i);
		if (i == 0){
			var text = document.createElement("input");
			text.name = "pType_" + currentCount.toString()
			text.addEventListener('input', function() {
				this.value = this.value.toUpperCase();
        	});
			text.class = "line-items-container"
			cell.appendChild(text);			
		}
		if (i == 1){
			var text2 = document.createElement("input");
			text2.name = "pPercentage_" + currentCount.toString()
			text2.class = "line-items-container"
			cell.appendChild(text2);
		}
		if (i == 2){
			var text3 = document.createElement("input");
			text3.name = "pAmount_" + currentCount.toString()
			text3.class = "line-items-container"
			cell.appendChild(text3);			
		}
		if (i == 3){
			var selection = document.createElement("select");
			selection.name = "pStatus_" + currentCount.toString()
			cell.style.textAlign = "center";
			selection.class = "line-items-container"
			// Add options to the sele5t element
			var option1 = document.createElement("option");
			option1.value = "DONE";
			option1.text = "DONE";
			selection.appendChild(option1);

			var option2 = document.createElement("option");
			option2.value = "REQUEST";
			option2.text = "REQUEST";
			selection.appendChild(option2);		
			
			cell.appendChild(selection)
		}
		if (i == 4){
			var date = document.createElement("input")
			date.type = 'date'
			date.name = 'pDate_'+ currentCount.toString()
			cell.appendChild(date)
		}
		if (i == 5){
			var removeButton = document.createElement("button");
			removeButton.id = "removeRowPayment"
			removeButton.className = "button add-new-button removeRowPayment"
			removeButton.class = "line-items-container"
			removeButton.textContent = "-"
			cell.appendChild(removeButton)
		}
	}
}

function add() {
	var scopeOfWorkTable = document.getElementById("scopeOfWork");
	var tbody = scopeOfWorkTable.tBodies[0]
	var rows = tbody.rows.length;
	var r = tbody.insertRow(rows); // Insert the row at the end of this tbody
	var number_of_scopes = document.getElementById("number_of_scopes");
	var currentCount = parseInt(number_of_scopes.value, 10)
	number_of_scopes.value = currentCount + 1
	r.dataset.index = currentCount ;
	for (var i = 0; i < 8; i++) {
		var cell
		if (i == 0) {
			cell = r.insertCell(i); // Insert the first cell
			cell.textContent = rows + 1;
			cell.style.textAlign = "center";
			cell.class = "line-items-container";
		}
		else {
			cell = r.insertCell(i); // Insert the other cells
   		}
		if (i == 1 && woProject == 'EMR') {
			var selection = document.createElement("select");
			selection.name = "scopeOfWork_" + currentCount.toString()
			cell.style.textAlign = "left";
			selection.class = "line-items-container"
			// Add options to the sele5t element
			var option1 = document.createElement("option");
			option1.value = "Clamp Pole Single 2,5 inch";
			option1.setAttribute('data-price', 9000)
			option1.text = "Clamp Pole Single 2,5 inch";
			selection.appendChild(option1);

			var option2 = document.createElement("option");
			option2.value = "Dead End Fitting / Fixed / clamp Buaya 25/50"
			option2.setAttribute('data-price', 13000)
			option2.text = "Dead End Fitting / Fixed / clamp Buaya 25/50";
			selection.appendChild(option2);

			var option3 = document.createElement("option");
			option3.value = "Stopping M6";
			option3.setAttribute('data-price', 500)
			option3.text = "Stopping M6";
			selection.appendChild(option3);

			var option4 = document.createElement("option");
			option4.value = "Clamp 8 (Clamp Gantung)";
			option4.setAttribute('data-price', 12500)
			option4.text = "Clamp 8 (Clamp Gantung)";
			selection.appendChild(option4);

			var option5 = document.createElement("option");
			option5.value = "Suspension Corong";
			option5.setAttribute('data-price', 14000)
			option5.text = "Suspension Corong";
			selection.appendChild(option5);

			var option6 = document.createElement("option");
			option6.value = "Span Wartel M10";
			option6.setAttribute('data-price', 8000)
			option6.text = "Span Wartel M10";
			selection.appendChild(option6);

			var option7 = document.createElement("option");
			option7.value = "Plat Belt 20mm / Stainless Belt";
			option7.setAttribute('data-price', 135000)
			option7.text = "Plat Belt 20mm / Stainless Belt";
			selection.appendChild(option7);

			var option8 = document.createElement("option");
			option8.value = "Buldog Grip M8";
			option8.setAttribute('data-price', 7500)
			option8.text = "Buldog Grip M8";
			selection.appendChild(option8);

			var option9 = document.createElement("option");
			option9.value = "Steel Clamp";
			option9.setAttribute('data-price', 12000)
			option9.text = "Steel Clamp";
			selection.appendChild(option9);

			var option10 = document.createElement("option");
			option10.value = "Helical SET 24 Core";
			option10.setAttribute('data-price', 7800)
			option10.text = "Helical SET 24 Core";
			selection.appendChild(option10);

			var option11 = document.createElement("option");
			option11.value = "Helical SET 144 Core";
			option11.setAttribute('data-price', 18000)
			option11.text = "Helical SET 144 Core";
			selection.appendChild(option11);

			var option12 = document.createElement("option");
			option12.value = "Helical SET 288 Core";
			option12.setAttribute('data-price', 20000)
			option12.text = "Helical SET 288 Core";
			selection.appendChild(option12);

			var option13 = document.createElement("option");
			option13.value = "Bracket A (for Helical Dead End)";
			option13.setAttribute('data-price', 4500)
			option13.text = "Bracket A (for Helical Dead End";
			selection.appendChild(option13);

			// User create custom object 
			var option14 = document.createElement("option");
			option14.value = "Add Custom Scope Of Work";
			option14.text = "Add Custom Scope Of Work"
			selection.appendChild(option14)
			// Updating the unit price when selecting items
			selection.onchange = function() {
				var selectedOption = this.options[this.selectedIndex]
				var selectedPrice = selectedOption.getAttribute('data-price')
				var unitPriceInput = this.parentNode.parentNode.cells[4].querySelector('input');
				unitPriceInput.value = selectedPrice
				var totalActualInput = this.parentNode.parentNode.cells[5].querySelector('input')
				var qtyActual = this.parentNode.parentNode.cells[3].querySelector('input')
				var grandTotalUpdater = document.getElementById('grand-total-payment')
				grandTotalUpdater.addEventListener('change', function(event){
					this.value = unitPriceInput.value * qtyActual
				});
				if (qtyActual.value == 0){
						totalActualInput.value = ''
					}
					else {
						totalActualInput.value = qtyActual.value * unitPriceInput.value
					}
				if (this.value == "Add Custom Scope Of Work") {
					var customInput = document.createElement("input");
					this.style.display = "none"
					customInput.type = "text"
					customInput.name = "scopeOfWork_" + currentCount.toString()
					applyStyles(customInput, "text")
					this.parentNode.insertBefore(customInput, this.nextSibling);
					
				}

				unitPriceInput.addEventListener('input', function(event) {
					totalBoqInput.value = this.value * qty.value
					
					updateTotals();
					termsAmountCalculation();
					taxAmountCalculation();
					updateGrandTotal();
				});

				// Total Actual
				qtyActual.addEventListener('input', function(event) {
					if (this.value == 0){
						totalActualInput.value = ''
					}
					else {
						totalActualInput.value = this.value * unitPriceInput.value
						
						updateTotals();
						termsAmountCalculation();
						taxAmountCalculation();
						updateGrandTotal();
					}
				});
			};
			cell.appendChild(selection);
		}
		if (i == 1 && woProject == 'LN') {
			var selection = document.createElement("select");
			selection.name = "scopeOfWork_" + currentCount.toString()
			cell.style.textAlign = "left";
			selection.class = "line-items-container"
			// Add options to the sele5t element
			var option1 = document.createElement("option");
			option1.value = "Clamp Pole 2,5 inch Linknet Standard";
			option1.setAttribute('data-price', 12000)
			option1.text = "Clamp Pole 2,5 inch Linknet Standard";
			selection.appendChild(option1);

			var option2 = document.createElement("option");
			option2.value = "Stopping M6";
			option2.setAttribute('data-price', 500)
			option2.text = "Stopping M6";
			selection.appendChild(option2);

			var option3 = document.createElement("option");
			option3.value = "Span Wartel M10";
			option3.setAttribute('data-price', 8000)
			option3.text = "Span Wartel M10";
			selection.appendChild(option3);

			var option4 = document.createElement("option");
			option4.value = "Buldog Grip M8";
			option4.setAttribute('data-price', 7500)
			option4.text = "Buldog Grip M8";
			selection.appendChild(option4);

			// User create custom object 
			var option5 = document.createElement("option");
			option5.value = "Add Custom Scope Of Work";
			option5.text = "Add Custom Scope Of Work"
			selection.appendChild(option5)
			// Updating the unit price when selecting items
			selection.onchange = function() {
				var selectedOption = this.options[this.selectedIndex]
				var selectedPrice = selectedOption.getAttribute('data-price')
				var unitPriceInput = this.parentNode.parentNode.cells[4].querySelector('input');
				unitPriceInput.value = selectedPrice
				var totalActualInput = this.parentNode.parentNode.cells[5].querySelector('input')
				var qtyActual = this.parentNode.parentNode.cells[3].querySelector('input')
				var grandTotalUpdater = document.getElementById('grand-total-payment')
				grandTotalUpdater.addEventListener('change', function(event){
					this.value = unitPriceInput.value * qtyActual
				});
				if (qtyActual.value == 0){
						totalActualInput.value = ''
					}
					else {
						totalActualInput.value = qtyActual.value * unitPriceInput.value
					}
				if (this.value == "Add Custom Scope Of Work") {
					var customInput = document.createElement("input");
					this.style.display = "none"
					customInput.type = "text"
					customInput.name = "scopeOfWork_" + currentCount.toString()
					applyStyles(customInput, "text")
					this.parentNode.insertBefore(customInput, this.nextSibling);
					
				}

				unitPriceInput.addEventListener('input', function(event) {
					totalBoqInput.value = this.value * qty.value
					
					updateTotals();
					termsAmountCalculation();
					taxAmountCalculation();
					updateGrandTotal();
				});

				// Total Actual
				qtyActual.addEventListener('input', function(event) {
					if (this.value == 0){
						totalActualInput.value = ''
					}
					else {
						totalActualInput.value = this.value * unitPriceInput.value
						
						updateTotals();
						termsAmountCalculation();
						taxAmountCalculation();
						updateGrandTotal();
					}
				});
			};
			cell.appendChild(selection);
		}
		if (i == 2) {
			var select2 = document.createElement("select");
            select2.name = "unit_" + currentCount.toString()
			select2.class = "line-items-container"


            var option1 = document.createElement("option");
			option1.value = "Pcs";
			option1.text = "Pcs";
			select2.appendChild(option1);

            var option2 = document.createElement("option");
			option2.value = "Roll";
			option2.text = "Roll";
			select2.appendChild(option2);

            var option3 = document.createElement("option");
			option3.value = "Meter";
			option3.text = "Meter";
			select2.appendChild(option3);
            
			cell.appendChild(select2);
		}
		if (i == 3) {
			var num1 = document.createElement("input");
			num1.name = "qtyA_" + currentCount.toString()
			num1.type = "number";
			num1.class = "line-items-container"


			cell.appendChild(num1)
		}
		if (i == 4) { 
			var text = document.createElement("input");
			text.name = "unitPrice_" + currentCount.toString()
			text.class = "line-items-container"

			cell.appendChild(text);
		}
		if (i == 5) { 
			var text3 = document.createElement("input");
			text3.name = "totalA_" + currentCount.toString()
			text3.class = "line-items-container"

			cell.appendChild(text3);
		}
		if (i == 6) { 
			var text4 = document.createElement("input");
			text4.name = "remarks_" + currentCount.toString()
			text4.class = "line-items-container"
			cell.style.textAlign = "left";
			cell.appendChild(text4);
		}
		if (i == 7){
			var removeButton = document.createElement("button");
			removeButton.id = "removeRow"
			removeButton.className = "button add-new-button removeRowButton"
			removeButton.class = "line-items-container"
			removeButton.textContent = "-"
			cell.appendChild(removeButton)
		}
	}
}
function applyStyles(element, type) {
	element.style.width = "100%"; // Make element take the full width of the cell
	element.style.height = "30px"; // Set a fixed height for a tighter look
	element.style.boxSizing = "border-box"; // Include padding and border in the width and height
	element.style.border = "1px solid #ddd"; // Uniform border style
	element.style.padding = "4px"; // Consistent padding
	element.style.margin = "0"; // Remove margins to avoid unnecessary spacing
}
// CHANGING THE TERMS SELECTION CELL
document.getElementById('terms-selection').onchange = function(){
  if (this.value == "CREATE") {
    var customInput = document.createElement("input");
    customInput.type = "text";
    customInput.name = "terms-percentage-cell"; // Using the same name for consistency
    customInput.id = "custom-terms-percentage-cell"; // Giving an ID for easier access
	customInput.textContent = ''

    // Hide the dropdown
    this.style.display = "none";

    // Insert the new input field after the dropdown
    this.parentNode.insertBefore(customInput, this.nextSibling);
	}
	var percentageAmount = this.options[this.selectedIndex].getAttribute('data-percentage-amount');
	var thisRemarks = this.options[this.selectedIndex].getAttribute('data-remarks');

document.getElementsByName('terms-percentage-cell')[0].value = percentageAmount;
document.getElementsByName('payment-remarks-cell')[0].value = thisRemarks;  
}

document.getElementById('bank').onchange = function() {
  if (this.value == "CREATE") {
    var customInput = document.createElement("input");
    customInput.type = "text";
    customInput.name = "bank";
    customInput.id = "bank_custom"; // Use a different ID to avoid conflicts

    // Add the uppercase listener to the new input
    addUppercaseListener(customInput);

    this.style.display = "none";
    this.parentNode.insertBefore(customInput, this.nextSibling);
  }
};

document.getElementById('customer').onchange = function() {
  if (this.value == "CREATE") {
    var customInput = document.createElement("input");
    customInput.type = "text";
    customInput.name = "customer";
    customInput.id = "customer_custom"; // Use a different ID to avoid conflicts

    // Add the uppercase listener to the new input
    addUppercaseListener(customInput);

    this.style.display = "none";
    this.parentNode.insertBefore(customInput, this.nextSibling);
  }
};

document.getElementById('region').onchange = function() {
  if (this.value == "CREATE") {
    var customInput = document.createElement("input");
    customInput.type = "text";
    customInput.name = "region";
    customInput.id = "region_custom"; // Use a different ID to avoid conflicts

    // Add the uppercase listener to the new input
    addUppercaseListener(customInput);

    this.style.display = "none";
    this.parentNode.insertBefore(customInput, this.nextSibling);
  }
};

// CHANGING THE TAX SELECTION CELL
document.getElementById('tax-cell').onchange = function(){
  var percentageAmount = this.options[this.selectedIndex].getAttribute('data-tax-percentage-amount');
  document.getElementsByName('tax-percentage-cell')[0].value = percentageAmount;
}

document.addEventListener('input', function(event) {
	updateTotals()
	termsAmountCalculation()
	taxAmountCalculation()
	updateGrandTotal()

});
document.addEventListener('change', function(event) {
	updateTotals()
	termsAmountCalculation()
	taxAmountCalculation()
	updateGrandTotal()
});


// REMOVE BUTTON ON SCOPE OF WORK
document.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('scopeOfWork').addEventListener('click', function(event) {
        if (event.target && event.target.className.includes('removeRowButton')) {
        var row = event.target.closest('tr');
            if (row) {
                row.remove(); // Remove the row
                reIndexRows('scopeOfWork'); // Re-index rows after removal
                number_of_scopes = document.getElementById('number_of_scopes')
                number_of_scopes.value -= 1
                updateTotals()
                termsAmountCalculation()
                taxAmountCalculation()
                updateGrandTotal()
            }
        }
    });
});

// REMOVE BUTTON ON DEDUCTION
document.addEventListener('DOMContentLoaded', (event) => {
	// Event delegation
    document.getElementById('payment-table').addEventListener('click', function(event) {
        if (event.target && event.target.className.includes('removeRowDed')) {
        var row = event.target.closest('tr');
            if (row) {
                row.remove(); // Remove the row
                reIndexRowsDed('deduction-row'); // Re-index rows after removal
                number_of_deduction = document.getElementById('number_of_deduction')
                number_of_deduction.value -= 1
                number_of_deduction.dataset.initialValue = number_of_deduction.value 
                updateTotals()
                termsAmountCalculation()
                taxAmountCalculation()
                updateGrandTotal()
            }
        }
    });
});
// REMOVE BUTTON ON PAYMENT TABLE
document.addEventListener('DOMContentLoaded', (event) => {
	// Event delegation
    document.getElementById('paymentTable').addEventListener('click', function(event) {
        if (event.target && event.target.className.includes('removeRowPayment')) {
        var row = event.target.closest('tr');
            if (row) {
                row.remove(); // Remove the row
                reIndexRowsPayment('paymentTable'); // Re-index rows after removal
                number_of_payment = document.getElementById('number_of_payment')
                number_of_payment.value -= 1
            }
        }
    });
});



document.getElementById('wo_date').addEventListener('input', function () {
// Extract the year and month from the date
var date = this.value;
var yearMonth = date ? date.substr(2, 2) + date.substr(5, 2) : '';

// Set the YYMM format to the 'shortdate' input field
document.getElementById('shortdate').value = yearMonth;
});
document.getElementById('wo_number').addEventListener('input', function () {
// Check if the input is not more than 4 digits and if it is within the 0-9999 range
if (this.value.length > 4 || parseInt(this.value, 10) > 9999) {
this.value = this.value.slice(0, 4); // Limit to the first 4 digits
}
});
document.getElementsByName('request_by')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});
document.getElementsByName('city')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('account_name')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('category')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('project')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('account_number')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('phone_number')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('npwp')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('clusterName')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});document.getElementsByName('siteId')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});
document.getElementsByName('hp')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});
document.getElementsByName('odbId')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});
document.getElementsByName('suffixId')[0].addEventListener('input', function () {
this.value = this.value.toUpperCase();
});
</script>

{% endblock %}
